<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>El Ahorcado</title>
</head>

<body>
    <div class="container">
        <h1 class="text-center">El Ahorcado</h1>
        <label for="campoNombre" id="nombreusuario">Ingrese su usuario</label>
        <input type="text" id="campoNombre"/>        
        <button id="aceptarNombre" onclick="nombre()">Aceptar</button>
        <div class="float-right">Intentos fallidos <span id="fallos">0</span> of <span id="maximosFallos"></span></div>
        <div class="text-center">
            <p>Adivina la palabra</p>
            <p id="palabraResaltada"></p>
            <div id="keyboard"></div>
        </div>
        <button id="jugarNuevo"  style="visibility: hidden;" onclick="reiniciar()">Jugar de nuevo</button>
    </div>

</body>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

    const socket = io('http://localhost:4000');

    let answer = '';
    let palabrau = '';
    let general = [];
    let anfitrion = '';
    let todosletras = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','ñ','o','p','q','r','s','t','u','v','w','x','y','z'];
    let leusadas = [];
    let leactual= '';
    let partida = false;
    let usuario = 'pepito perez';

    socket.on('palabra-recibir', (palabra, id) => {
        palabrau = palabra;
        anfitrion = id;
        console.log(palabrau, anfitrion)
        document.getElementById('palabraResaltada').innerHTML = palabrau.split('').map(letter => (general.indexOf(letter) >= 0 ? letter : " _ ")).join('');
        document.getElementById('maximosFallos').innerHTML = 6;      
    })

    function ganar(){
        if(document.getElementById('palabraResaltada').innerHTML.indexOf('_') == -1){
            alert('Ganaste, Felicitaciones');
            socket.emit('ganador', usuario);
            document.getElementById('jugarNuevo').style.visibility = 'visible';
        }
    }

    function nombre(){
        usuario = document.getElementById('campoNombre').value;
        for(let i = 0; i < todosletras.length; i++){
            document.getElementById(todosletras[i]).disabled = false;            
        }
        document.getElementById('campoNombre').style.visibility = 'hidden';
        document.getElementById('aceptarNombre').style.visibility = 'hidden';
        document.getElementById('nombreusuario').style.visibility = 'hidden';
    }

    reiniciar = () => {
        location.reload();
    }

    socket.on('ganador-a-todos', (usuario)=>{
        alert('El ganador es: ' + usuario);
        for(let i = 0; i < todosletras.length; i++){
            document.getElementById(todosletras[i]).disabled = false;
        }
    })

    socket.on('respuesta-a-usuario', (respuesta) => {
        if (respuesta == 1) {
            general.indexOf(leactual) === -1 ? general.push(leactual) : null ;
            if(palabrau.indexOf(leactual) >= 0){
                document.getElementById('palabraResaltada').innerHTML = palabrau.split('').map(letter => (general.indexOf(letter) >= 0 ? letter : " _ ")).join('');
            }
        } else if (respuesta == 0) {
            document.getElementById('fallos').innerHTML = parseInt(document.getElementById('fallos').innerHTML) + 1;
        }

        if (parseInt(document.getElementById('fallos').innerHTML) == 6) {
            for(let i = 0; i < todosletras.length; i++){
            document.getElementById(todosletras[i]).disabled = true;
            }
            socket.emit('perdedor', usuario);
            
        }
        ganar();

        for(let i = 0; i < todosletras.length; i++){
            document.getElementById(todosletras[i]).disabled = false;
        }

        for (let i = 0; i < leusadas.length; i++) {
            document.getElementById(leusadas[i]).disabled = true;
        }

    })

    function generadorBotones() {
        let buttonsHTML = 'abcdefghijklmnñopqrstuvwxyz'.split('').map(letter =>
            `
        <button 
        class="btn btn-lg btn-primary m-2" 
        id='` + letter + `'
        name="btn letras" 
        onClick="handleGuess('` + letter + `')"
        disabled="true"
        >  
        ` + letter + `
        </button>  
        `
        ).join('');
        document.getElementById('keyboard').innerHTML = buttonsHTML;
    }

    function status(){
        socket.emit('partida-empezada', (Response)=>{
            console.log(Response);
            partida = Response;
            console.log(partida);
        });
    }

    function handleGuess(letraEscogida) {
        status();

        if( partida == false ){
            alert('Espera a que el anfitrion empiece la partida');
        }else if( partida == true && document.getElementById('palabraResaltada').innerHTML == '' ){
            alert('La partida ya empezo, espera a que el anfitrion empieze una nueva partida');
        }else{
            document.getElementById(letraEscogida).setAttribute('disabled', true);
            leusadas.push(letraEscogida);
            leactual = letraEscogida;
            socket.emit('letra-enviada', letraEscogida, socket.id, usuario);
            for(let i = 0; i < todosletras.length; i++){
                document.getElementById(todosletras[i]).disabled = true;
            }
        }
        
    }

    generadorBotones();

</script>

</html>